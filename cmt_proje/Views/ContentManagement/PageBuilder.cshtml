@model List<cmt_proje.Core.Entities.PageContentBlock>
@{
    ViewData["Title"] = $"Page Builder - {ViewBag.PageKey}";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var pageKey = ViewBag.PageKey as string ?? "Home";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-file-earmark-text"></i>
                Page Builder: @pageKey
            </h2>
            <p class="text-muted mb-0">Drag and drop to reorder blocks. Click to edit.</p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Add Block Button -->
    <div class="mb-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBlockModal">
            <i class="bi bi-plus-circle"></i> Add Block
        </button>
    </div>

    <!-- Preview Mode Button (Fixed Top Right) -->
    <div id="previewModeIndicator" class="preview-mode-indicator" style="display: none;">
        <button type="button" class="btn btn-warning" id="continueEditBtn">
            <i class="bi bi-pencil-square"></i> Edite Devam Et
        </button>
    </div>

    <!-- Blocks Container (Sortable) -->
    <div id="blocksContainer" class="blocks-list">
        <!-- Preview Block Container (Temporary) -->
        <div id="previewBlockContainer" style="display: none;"></div>
        @if (Model != null && Model.Any())
        {
            @foreach (var block in Model.OrderBy(b => b.DisplayOrder))
            {
                <div class="block-item card mb-3" data-block-id="@block.Id">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-grip-vertical text-muted me-2" style="cursor: move;"></i>
                            <strong>@block.BlockType</strong>
                            @if (!string.IsNullOrEmpty(block.Title))
                            {
                                <span class="text-muted ms-2">- @block.Title</span>
                            }
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary edit-block-btn" data-block-id="@block.Id">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-block-btn" data-block-id="@block.Id">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @switch (block.BlockType)
                        {
                            case "Heading":
                                <h3>@block.Title</h3>
                                break;
                            case "Text":
                                <div>@Html.Raw(block.Content)</div>
                                break;
                            case "Image":
                                @if (!string.IsNullOrEmpty(block.ImageUrl))
                                {
                                    <img src="@block.ImageUrl" alt="@block.Title" class="img-fluid" style="max-height: 300px;" />
                                }
                                break;
                            case "Button":
                                <a href="@block.LinkUrl" class="btn btn-primary">@block.LinkText</a>
                                break;
                            case "HTML":
                                <div>@Html.Raw(block.Content)</div>
                                break;
                            default:
                                <p class="text-muted">@block.Content</p>
                                break;
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No blocks yet. Click "Add Block" to get started.
            </div>
        }
    </div>
</div>

<!-- Add Block Modal -->
<div class="modal fade" id="addBlockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Block</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBlockForm">
                    <input type="hidden" name="PageKey" value="@pageKey" />
                    <input type="hidden" name="__RequestVerificationToken" value="@Html.AntiForgeryToken()" />
                    
                    <div class="mb-3">
                        <label class="form-label">Block Type <span class="text-danger">*</span></label>
                        <select name="BlockType" class="form-select" required>
                            <option value="">-- Select Type --</option>
                            <option value="Heading">Heading</option>
                            <option value="Text">Text</option>
                            <option value="Image">Image</option>
                            <option value="Button">Button</option>
                            <option value="HTML">HTML</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="Title" class="form-control" placeholder="Block title" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea name="Content" class="form-control" rows="5" placeholder="Enter content (HTML supported)"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="url" name="ImageUrl" class="form-control" placeholder="https://example.com/image.jpg" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Link URL</label>
                        <input type="url" name="LinkUrl" class="form-control" placeholder="https://example.com" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Link Text</label>
                        <input type="text" name="LinkText" class="form-control" placeholder="Click here" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">CSS Class</label>
                        <input type="text" name="CssClass" class="form-control" placeholder="custom-class" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="previewAddBlockBtn">
                    <i class="bi bi-eye"></i> Ön İzleme
                </button>
                <button type="button" class="btn btn-primary" id="saveBlockBtn">Save Block</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Block Modal -->
<div class="modal fade" id="editBlockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Block</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editBlockForm">
                    <input type="hidden" name="Id" id="editBlockId" />
                    <input type="hidden" name="PageKey" value="@pageKey" />
                    <input type="hidden" name="__RequestVerificationToken" value="@Html.AntiForgeryToken()" />
                    
                    <div class="mb-3">
                        <label class="form-label">Block Type <span class="text-danger">*</span></label>
                        <select name="BlockType" id="editBlockType" class="form-select" required>
                            <option value="Heading">Heading</option>
                            <option value="Text">Text</option>
                            <option value="Image">Image</option>
                            <option value="Button">Button</option>
                            <option value="HTML">HTML</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" name="Title" id="editBlockTitle" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea name="Content" id="editBlockContent" class="form-control" rows="5"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="url" name="ImageUrl" id="editBlockImageUrl" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Link URL</label>
                        <input type="url" name="LinkUrl" id="editBlockLinkUrl" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Link Text</label>
                        <input type="text" name="LinkText" id="editBlockLinkText" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">CSS Class</label>
                        <input type="text" name="CssClass" id="editBlockCssClass" class="form-control" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="previewEditBlockBtn">
                    <i class="bi bi-eye"></i> Ön İzleme
                </button>
                <button type="button" class="btn btn-primary" id="updateBlockBtn">Update Block</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .blocks-list {
            min-height: 200px;
        }

        .block-item {
            cursor: move;
            transition: transform 0.2s ease;
        }

        .block-item:hover {
            transform: translateX(4px);
        }

        .block-item.sortable-ghost {
            opacity: 0.4;
        }

        .block-item.sortable-drag {
            opacity: 0.8;
        }

        /* Preview Mode Indicator */
        .preview-mode-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1050;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .preview-block-item {
            border: 2px dashed #0dcaf0;
            background-color: #f0f9ff;
        }

        .preview-block-item::before {
            content: "ÖN İZLEME";
            position: absolute;
            top: -10px;
            left: 10px;
            background: #0dcaf0;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        // Initialize Sortable
        const blocksContainer = document.getElementById('blocksContainer');
        if (blocksContainer) {
            new Sortable(blocksContainer, {
                handle: '.bi-grip-vertical',
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    // Reorder blocks
                    const blocks = Array.from(blocksContainer.querySelectorAll('.block-item'));
                    const orders = blocks.map((block, index) => ({
                        Id: parseInt(block.dataset.blockId),
                        Order: index + 1
                    }));

                    fetch('@Url.Action("ReorderBlocks", "ContentManagement")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify(orders)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        }
                    });
                }
            });
        }

        // Add Block
        document.getElementById('saveBlockBtn')?.addEventListener('click', function() {
            const form = document.getElementById('addBlockForm');
            const formData = new FormData(form);
            
            // Convert FormData to JSON object
            const jsonData = {
                PageKey: formData.get('PageKey'),
                BlockType: formData.get('BlockType'),
                Title: formData.get('Title') || null,
                Content: formData.get('Content') || null,
                ImageUrl: formData.get('ImageUrl') || null,
                LinkUrl: formData.get('LinkUrl') || null,
                LinkText: formData.get('LinkText') || null,
                CssClass: formData.get('CssClass') || null
            };

            // Get anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

            fetch('@Url.Action("AddBlock", "ContentManagement")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token || ''
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Clear preview state before reload
                    clearPreviewState();
                    location.reload();
                } else {
                    alert(data.message || 'Error adding block');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata oluştu: ' + error.message);
            });
        });

        // Edit Block
        document.querySelectorAll('.edit-block-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const blockId = this.dataset.blockId;
                
                // Fetch block data
                fetch('@Url.Action("GetBlock", "ContentManagement")?id=' + blockId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const block = data.block;
                            document.getElementById('editBlockId').value = block.id;
                            document.getElementById('editBlockType').value = block.blockType;
                            document.getElementById('editBlockTitle').value = block.title || '';
                            document.getElementById('editBlockContent').value = block.content || '';
                            document.getElementById('editBlockImageUrl').value = block.imageUrl || '';
                            document.getElementById('editBlockLinkUrl').value = block.linkUrl || '';
                            document.getElementById('editBlockLinkText').value = block.linkText || '';
                            document.getElementById('editBlockCssClass').value = block.cssClass || '';
                            
                            const modal = new bootstrap.Modal(document.getElementById('editBlockModal'));
                            modal.show();
                        } else {
                            alert(data.message || 'Error loading block');
                        }
                    });
            });
        });

        // Delete Block
        document.querySelectorAll('.delete-block-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!confirm('Are you sure you want to delete this block?')) return;
                
                const blockId = this.dataset.blockId;
                const formData = new FormData();
                formData.append('id', blockId);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                fetch('@Url.Action("DeleteBlock", "ContentManagement")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Error deleting block');
                    }
                });
            });
        });

        // Update Block
        document.getElementById('updateBlockBtn')?.addEventListener('click', function() {
            const form = document.getElementById('editBlockForm');
            const formData = new FormData(form);
            
            // Convert FormData to JSON object
            const jsonData = {
                Id: parseInt(formData.get('Id')),
                PageKey: formData.get('PageKey'),
                BlockType: formData.get('BlockType'),
                Title: formData.get('Title') || null,
                Content: formData.get('Content') || null,
                ImageUrl: formData.get('ImageUrl') || null,
                LinkUrl: formData.get('LinkUrl') || null,
                LinkText: formData.get('LinkText') || null,
                CssClass: formData.get('CssClass') || null
            };

            fetch('@Url.Action("UpdateBlock", "ContentManagement")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Clear preview state
                    clearPreviewState();
                    location.reload();
                } else {
                    alert(data.message || 'Error updating block');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata oluştu: ' + error.message);
            });
        });

        // Preview Functions
        function getFormData(formId) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            return data;
        }

        function saveFormDataToStorage(formId, isEdit = false) {
            const data = getFormData(formId);
            data.isEdit = isEdit;
            sessionStorage.setItem('previewBlockData', JSON.stringify(data));
        }

        function loadFormDataFromStorage(formId) {
            const stored = sessionStorage.getItem('previewBlockData');
            if (!stored) return false;
            
            const data = JSON.parse(stored);
            const form = document.getElementById(formId);
            
            // Restore form values
            if (data.BlockType) {
                const blockTypeSelect = form.querySelector('[name="BlockType"]');
                if (blockTypeSelect) blockTypeSelect.value = data.BlockType;
            }
            if (data.Title) {
                const titleInput = form.querySelector('[name="Title"]');
                if (titleInput) titleInput.value = data.Title;
            }
            if (data.Content) {
                const contentTextarea = form.querySelector('[name="Content"]');
                if (contentTextarea) contentTextarea.value = data.Content;
            }
            if (data.ImageUrl) {
                const imageUrlInput = form.querySelector('[name="ImageUrl"]');
                if (imageUrlInput) imageUrlInput.value = data.ImageUrl;
            }
            if (data.LinkUrl) {
                const linkUrlInput = form.querySelector('[name="LinkUrl"]');
                if (linkUrlInput) linkUrlInput.value = data.LinkUrl;
            }
            if (data.LinkText) {
                const linkTextInput = form.querySelector('[name="LinkText"]');
                if (linkTextInput) linkTextInput.value = data.LinkText;
            }
            if (data.CssClass) {
                const cssClassInput = form.querySelector('[name="CssClass"]');
                if (cssClassInput) cssClassInput.value = data.CssClass;
            }
            if (data.Id) {
                const idInput = form.querySelector('[name="Id"]');
                if (idInput) idInput.value = data.Id;
            }
            
            return data.isEdit || false;
        }

        function renderPreviewBlock(data) {
            const container = document.getElementById('previewBlockContainer');
            if (!container) return;

            let html = '<div class="block-item card mb-3 preview-block-item" style="position: relative;">';
            html += '<div class="card-header d-flex justify-content-between align-items-center bg-light">';
            html += '<div class="d-flex align-items-center">';
            html += '<i class="bi bi-grip-vertical text-muted me-2"></i>';
            html += '<strong>' + (data.BlockType || 'Block') + '</strong>';
            if (data.Title) {
                html += '<span class="text-muted ms-2">- ' + data.Title + '</span>';
            }
            html += '</div></div>';
            html += '<div class="card-body">';

            // Escape HTML for safety, but allow HTML content for HTML block type
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            switch (data.BlockType) {
                case 'Heading':
                    html += '<h3>' + escapeHtml(data.Title || '') + '</h3>';
                    break;
                case 'Text':
                    // Text block allows HTML (like the actual rendering)
                    html += '<div>' + (data.Content || '') + '</div>';
                    break;
                case 'Image':
                    if (data.ImageUrl) {
                        html += '<img src="' + escapeHtml(data.ImageUrl) + '" alt="' + escapeHtml(data.Title || '') + '" class="img-fluid" style="max-height: 300px;" onerror="this.style.display=\'none\'" />';
                    }
                    break;
                case 'Button':
                    html += '<a href="' + escapeHtml(data.LinkUrl || '#') + '" class="btn btn-primary">' + escapeHtml(data.LinkText || 'Button') + '</a>';
                    break;
                case 'HTML':
                    // Allow HTML for HTML block type
                    html += '<div>' + (data.Content || '') + '</div>';
                    break;
                default:
                    html += '<p class="text-muted">' + escapeHtml(data.Content || '') + '</p>';
                    break;
            }

            html += '</div></div>';
            container.innerHTML = html;
            container.style.display = 'block';
            
            // Insert at the beginning of blocks container (after preview container)
            const blocksContainer = document.getElementById('blocksContainer');
            if (blocksContainer) {
                // Find the first real block item (not preview container)
                const firstBlock = blocksContainer.querySelector('.block-item:not(.preview-block-item)');
                if (firstBlock) {
                    blocksContainer.insertBefore(container, firstBlock);
                } else {
                    // If no blocks, append to container
                    blocksContainer.appendChild(container);
                }
            }
        }

        function showPreviewMode() {
            document.getElementById('previewModeIndicator').style.display = 'block';
        }

        function hidePreviewMode() {
            document.getElementById('previewModeIndicator').style.display = 'none';
            document.getElementById('previewBlockContainer').style.display = 'none';
            document.getElementById('previewBlockContainer').innerHTML = '';
        }

        function clearPreviewState() {
            sessionStorage.removeItem('previewBlockData');
            hidePreviewMode();
        }

        // Preview Add Block
        document.getElementById('previewAddBlockBtn')?.addEventListener('click', function() {
            const form = document.getElementById('addBlockForm');
            const blockType = form.querySelector('[name="BlockType"]').value;
            
            if (!blockType) {
                alert('Lütfen önce Block Type seçin.');
                return;
            }

            // Save form data to storage
            saveFormDataToStorage('addBlockForm', false);
            
            // Get form data
            const formData = getFormData('addBlockForm');
            
            // Save preview data to sessionStorage for Home page
            sessionStorage.setItem('previewBlockPreview', JSON.stringify(formData));
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBlockModal'));
            if (modal) modal.hide();
            
            // Open Home page in new tab to see preview
            const homeUrl = '@Url.Action("Home", "Home")?preview=true';
            window.open(homeUrl, '_blank');
            
            // Also render preview in current page
            renderPreviewBlock(formData);
            showPreviewMode();
        });

        // Preview Edit Block
        document.getElementById('previewEditBlockBtn')?.addEventListener('click', function() {
            const form = document.getElementById('editBlockForm');
            const blockType = form.querySelector('[name="BlockType"]').value;
            
            if (!blockType) {
                alert('Lütfen önce Block Type seçin.');
                return;
            }

            // Save form data to storage
            saveFormDataToStorage('editBlockForm', true);
            
            // Get form data
            const formData = getFormData('editBlockForm');
            const blockId = formData.Id;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editBlockModal'));
            if (modal) modal.hide();
            
            // Hide original block if editing
            if (blockId) {
                const originalBlock = document.querySelector(`[data-block-id="${blockId}"]`);
                if (originalBlock) {
                    originalBlock.style.display = 'none';
                }
            }
            
            // Render preview
            renderPreviewBlock(formData);
            showPreviewMode();
        });

        // Continue Edit Button
        document.getElementById('continueEditBtn')?.addEventListener('click', function() {
            const stored = sessionStorage.getItem('previewBlockData');
            if (!stored) return;
            
            const data = JSON.parse(stored);
            const isEdit = data.isEdit || false;
            
            // Hide preview
            hidePreviewMode();
            
            // Show original block if editing
            if (isEdit && data.Id) {
                const originalBlock = document.querySelector(`[data-block-id="${data.Id}"]`);
                if (originalBlock) {
                    originalBlock.style.display = '';
                }
            }
            
            // Open appropriate modal and load data
            if (isEdit) {
                loadFormDataFromStorage('editBlockForm');
                const modal = new bootstrap.Modal(document.getElementById('editBlockModal'));
                modal.show();
            } else {
                loadFormDataFromStorage('addBlockForm');
                const modal = new bootstrap.Modal(document.getElementById('addBlockModal'));
                modal.show();
            }
        });

        // Check for preview state on page load
        window.addEventListener('DOMContentLoaded', function() {
            const stored = sessionStorage.getItem('previewBlockData');
            if (stored) {
                const data = JSON.parse(stored);
                renderPreviewBlock(data);
                showPreviewMode();
                
                // Hide original block if editing
                if (data.isEdit && data.Id) {
                    const originalBlock = document.querySelector(`[data-block-id="${data.Id}"]`);
                    if (originalBlock) {
                        originalBlock.style.display = 'none';
                    }
                }
            }
        });


        // Clear preview when modal is closed via Cancel (but not via Preview)
        document.getElementById('addBlockModal')?.addEventListener('hidden.bs.modal', function() {
            // Only clear if not in preview mode
            if (!sessionStorage.getItem('previewBlockData')) {
                clearPreviewState();
            }
        });

        document.getElementById('editBlockModal')?.addEventListener('hidden.bs.modal', function() {
            // Only clear if not in preview mode
            if (!sessionStorage.getItem('previewBlockData')) {
                clearPreviewState();
            }
        });
    </script>
}

